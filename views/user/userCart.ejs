<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Bag</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/userCart.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <%- include('../../views/partials/user/header') %>

    <div class="breadcrumb-container">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Shopping Bag</li>
            </ol>
        </div>
    </div>

    <main class="container cart-section">
        <h1 class="section-title">Shopping Bag</h1>
        
        <div class="cart-container">
            <div class="cart-items">
                <div class="cart-header">
                    <h2>Your Items (<%= cartItems.length %>)</h2>
                </div>
                
                <div class="cart-list">
                    <% if (cartItems.length > 0) { %>
                        <% cartItems.forEach(item => { %>
                            <% if (item.productId && item.variant) { %>
                                <div class="cart-item" data-item-id="<%= item._id %>">
                                    <div class="item-image">
                                        <img src="<%= item.productId.productImage && item.productId.productImage.length > 0 ? item.productId.productImage[0] : '/api/placeholder/100/100' %>" alt="<%= item.productId.productName || 'Product' %>" />
                                    </div>
                                    <div class="item-details">
                                        <div class="item-top">
                                            <div class="item-info">
                                                <h3 class="item-title"><%= item.productId.productName || 'Unknown Product' %></h3>
                                                <div class="item-meta">
                                                    <span>Size: <%= item.variant.size || 'N/A' %></span>
                                                    <% if (item.isGiftWrapped) { %>
                                                        <span> | Gift Wrapped (+450₹)</span>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="item-price-container">
                                                <p class="item-price">₹<%= item.price.toFixed(2) %></p>
                                            </div>
                                        </div>
                                        <div class="item-actions">
                                            <div class="quantity-selector">
                                                <button class="quantity-btn" data-action="decrease" data-item-id="<%= item._id %>">−</button>
                                                <input type="text" class="quantity-input" value="<%= item.quantity %>" readonly>
                                                <button class="quantity-btn" data-action="increase" data-item-id="<%= item._id %>">+</button>
                                            </div>
                                            <div class="item-buttons">
                                                <button class="action-btn" onclick="removeFromCart('<%= item._id %>')"><i class="far fa-trash-alt"></i> Remove</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% } else { %>
                                <div class="cart-item" data-item-id="<%= item._id %>">
                                    <div class="item-image">
                                        <img src="/api/placeholder/100/100" alt="Invalid Product" />
                                    </div>
                                    <div class="item-details">
                                        <div class="item-top">
                                            <div class="item-info">
                                                <h3 class="item-title">Invalid Product</h3>
                                                <p class="item-subtitle">This product is no longer available.</p>
                                            </div>
                                            <div class="item-price-container">
                                                <p class="item-price">$<%= item.price ? item.price.toFixed(2) : '0.00' %></p>
                                            </div>
                                        </div>
                                        <div class="item-actions">
                                            <div class="quantity-selector">
                                                <button class="quantity-btn" disabled>−</button>
                                                <input type="text" class="quantity-input" value="<%= item.quantity || 1 %>" readonly>
                                                <button class="quantity-btn" disabled>+</button>
                                            </div>
                                            <div class="item-buttons">
                                                <button class="action-btn" onclick="removeFromCart('<%= item._id %>')"><i class="far fa-trash-alt"></i> Remove</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        <% }) %>
                    <% } else { %>
                        <p>Your cart is empty.</p>
                    <% } %>
                </div>
                
                <div class="cart-footer">
                    <a href="/shop" class="continue-shopping"><i class="fas fa-long-arrow-alt-left"></i> Continue Shopping</a>
                </div>
            </div>
            
            <div class="cart-summary">
                <h2 class="summary-title">Order Summary</h2>
                
                <div class="summary-row">
                    <span class="summary-label">Subtotal (<%= cartItems.length %> items)</span>
                    <span class="summary-value">₹<%= Number(subtotal).toFixed(2) %></span>
                </div>
                
                <% if (giftWrapTotal > 0) { %>
                    <div class="summary-row">
                        <span class="summary-label">Gift Packaging</span>
                        <span class="summary-value">₹<%= Number(giftWrapTotal).toFixed(2) %></span>
                    </div>
                <% } %>
                
                <% if (appliedCoupon) { %>
                    <div class="summary-row">
                        <span class="summary-label">Coupon Discount (<%= appliedCoupon.code %>)</span>
                        <span class="summary-value">-₹<%= Number(appliedCoupon.discount).toFixed(2) %></span>
                    </div>
                <% } %>
                
                <div class="summary-row">
                    <span class="summary-label">Shipping</span>
                    <span class="summary-value">Free</span>
                </div>
                
                <div class="total-row">
                    <span class="total-label">Total</span>
                    <span class="total-value">₹<%= Number(total).toFixed(2) %></span>
                </div>

                <div class="promo-code">
                    <button class="promo-toggle">
                        Apply Promo Code <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="promo-content">
                        <div class="promo-input">
                            <input type="text" class="promo-field" placeholder="Enter promo code">
                            <button class="promo-btn" id="apply-coupon-btn">Apply</button>
                        </div>
                        <% if (appliedCoupon) { %>
                            <div class="coupon-applied">
                                <div class="coupon-info">
                                    <span class="coupon-code"><%= appliedCoupon.code %></span>
                                    <span class="coupon-discount">Discount: ₹<%= Number(appliedCoupon.discount).toFixed(2) %></span>
                                </div>
                                <button class="coupon-remove" id="remove-coupon-btn">Remove</button>
                            </div>
                        <% } %>
                    </div>
                    <button class="coupon-modal-btn">Show Available Coupons</button>
                </div>   
                <button class="checkout-btn" onclick="window.location.href = '/checkout'">Proceed to Checkout</button>    
                <div class="secure-checkout">
                    <i class="fas fa-lock"></i> Secure Checkout
                </div>
            </div>
        </div>
    </main>

    <!-- Coupon Modal -->
    <div class="coupon-modal">
        <div class="coupon-modal-content">
            <span class="coupon-modal-close">&times;</span>
            <h2>Available Coupons</h2>
            <div class="coupon-list" id="coupon-list">
                <!-- Coupons will be dynamically loaded here -->
                <p class="loading-coupons">Loading available coupons...</p>
            </div>
        </div>
    </div>

    <%- include('../../views/partials/user/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Promo code toggle
  const promoToggle = document.querySelector('.promo-toggle');
  const promoContent = document.querySelector('.promo-content');
  if (promoToggle && promoContent) {
    promoToggle.addEventListener('click', function() {
      promoContent.classList.toggle('show');
      promoToggle.classList.toggle('open');
    });
  }

  // Coupon modal handling
  const couponModalBtn = document.querySelector('.coupon-modal-btn');
  const couponModal = document.querySelector('.coupon-modal');
  const couponModalClose = document.querySelector('.coupon-modal-close');
  const couponList = document.getElementById('coupon-list');

  if (couponModalBtn && couponModal && couponModalClose) {
    couponModalBtn.addEventListener('click', function() {
      couponModal.style.display = 'block';
      loadCoupons();
    });
    couponModalClose.addEventListener('click', function() {
      couponModal.style.display = 'none';
    });
    window.addEventListener('click', function(event) {
      if (event.target === couponModal) {
        couponModal.style.display = 'none';
      }
    });
  }

  // Apply coupon button
  const applyCouponBtn = document.getElementById('apply-coupon-btn');
  if (applyCouponBtn) {
    applyCouponBtn.addEventListener('click', function() {
      const promoField = document.querySelector('.promo-field');
      const couponCode = promoField.value.trim().toUpperCase();
      applyCoupon(couponCode);
    });
  }

  // Remove coupon button
  const removeCouponBtn = document.getElementById('remove-coupon-btn');
  if (removeCouponBtn) {
    removeCouponBtn.addEventListener('click', removeCoupon);
  }

  // Quantity buttons
  const quantityBtns = document.querySelectorAll('.quantity-btn');
  quantityBtns.forEach(btn => {
    btn.addEventListener('click', async function() {
      if (btn.disabled) return;

      const itemId = btn.getAttribute('data-item-id');
      const action = btn.getAttribute('data-action');
      const input = btn.parentElement.querySelector('.quantity-input');
      let quantity = parseInt(input.value);

      if (action === 'increase' && quantity < 5) {
        quantity++;
      } else if (action === 'decrease' && quantity > 1) {
        quantity--;
      } else {
        showToast(action === 'increase' ? 'Maximum quantity is 5' : 'Minimum quantity is 1', 'error');
        return;
      }

      input.value = quantity;
      try {
        const response = await fetch('/cart/update-quantity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itemId, quantity })
        });
        const data = await response.json();
        if (data.success) {
          showToast('Quantity updated', 'success');
          window.location.reload();
        } else {
          showToast(data.message || 'Failed to update quantity', 'error');
          input.value = quantity - (action === 'increase' ? 1 : -1);
        }
      } catch (error) {
        showToast('Error updating quantity', 'error');
        input.value = quantity - (action === 'increase' ? 1 : -1);
      }
    });
  });

  // Show toast notification
  function showToast(message, type) {
    Toastify({
      text: message,
      duration: 3000,
      gravity: 'top',
      position: 'right',
      backgroundColor: type === 'success' ? '#28a745' : '#dc3545',
      stopOnFocus: true
    }).showToast();
  }

  // Load available coupons
  async function loadCoupons() {
    try {
      couponList.innerHTML = '<p class="loading-coupons">Loading coupons...</p>';
      const response = await fetch('/coupons/available');
      if (!response.ok) throw new Error('Failed to load coupons');
      const coupons = await response.json();

      couponList.innerHTML = '';
      if (coupons.length > 0) {
        coupons.forEach(coupon => {
          const couponItem = document.createElement('div');
          couponItem.classList.add('coupon-item');
          couponItem.innerHTML = `
            <div class="coupon-details">
              <h3>${coupon.code}</h3>
              <p>Discount: ${coupon.discount}%</p>
              <p>Min Purchase: ₹${coupon.minPurchase.toFixed(2)}</p>
              <p>Expires: ${new Date(coupon.expiryDate).toLocaleDateString()}</p>
            </div>
            <button class="apply-coupon-btn" data-code="${coupon.code}">Apply</button>
          `;
          couponList.appendChild(couponItem);
        });

        document.querySelectorAll('.apply-coupon-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const code = this.getAttribute('data-code');
            applyCoupon(code);
            couponModal.style.display = 'none';
          });
        });
      } else {
        couponList.innerHTML = '<p>No coupons available.</p>';
      }
    } catch (error) {
      console.error('Error loading coupons:', error);
      couponList.innerHTML = '<p>Failed to load coupons. Try again later.</p>';
      showToast('Failed to load coupons', 'error');
    }
  }

  // Apply coupon
  async function applyCoupon(code) {
    if (!code) {
      showToast('Please enter a coupon code', 'error');
      return;
    }

    try {
      const response = await fetch('/cart/apply-coupon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ couponCode: code })
      });
      const data = await response.json();
      if (data.success) {
        showToast(data.message, 'success');
        window.location.reload();
      } else {
        showToast(data.message, 'error');
      }
    } catch (error) {
      console.error('Error applying coupon:', error);
      showToast('Failed to apply coupon', 'error');
    }
  }

  // Remove coupon
  async function removeCoupon() {
    try {
      const response = await fetch('/cart/remove-coupon', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (data.success) {
        showToast('Coupon removed', 'success');
        window.location.reload();
      } else {
        showToast(data.message, 'error');
      }
    } catch (error) {
      console.error('Error removing coupon:', error);
      showToast('Failed to remove coupon', 'error');
    }
  }

  // Remove item from cart
  async function removeFromCart(itemId) {
    if (!itemId) {
      showToast('Invalid item ID', 'error');
      return;
    }

    try {
      const response = await fetch('/cart/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ itemId })
      });
      const data = await response.json();
      if (data.success) {
        showToast('Item removed from cart', 'success');
        window.location.reload();
      } else {
        showToast(data.message, 'error');
      }
    } catch (error) {
      console.error('Error removing item:', error);
      showToast('Failed to remove item', 'error');
    }
  }
});
</script>
</body>
</html>